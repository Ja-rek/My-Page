<!DOCTYPE html>

<!--
  portfolYOU Jekyll theme by Youssef Raafat
  Free for personal and commercial use under the MIT license
  https://github.com/YoussefRaafatNasry/portfolYOU
-->

<html lang="en" class="h-100">

<head>

  
  
  

  

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:type" content="website">
  <meta property="og:title" content="Do we need interfaces for unit testing?">
  <meta property="og:description" content="These four “clean code” tips will dramatically improve your engineering team’s productivity">
  <meta property="og:image" content="/assets/jk.jpg">

  <title>Do we need interfaces for unit testing?</title>
  <meta name="description" content="These four “clean code” tips will dramatically improve your engineering team’s productivity">

  <link rel="shortcut icon" type="image/x-icon" href="/assets/favicon.ico">

  <!-- Theme style -->
  <script src="/assets/js/theme.js"></script>

  <!-- Font Awesome CDN -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.10.0/css/all.css">

  <!-- Bootstrap CSS CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">

  <!-- Animate CSS CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.0/animate.css">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/assets/css/style.css">

</head>

<body class="h-100 d-flex flex-column">

  <main class="flex-shrink-0 container mt-5">
    <nav class="navbar navbar-expand-lg navbar-themed">

  <a class="navbar-brand" href="/"><h5><b>Jarosław Szczerbaty</b></h5></a>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
    <i class="fas fa-1x fa-bars text-themed"></i>
  </button>

  <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
    <div class="navbar-nav ml-auto"><a class="nav-item nav-link " href="/projects/">Projects</a>

      <a class="nav-item nav-link active" href="/blog/">Blog</a>

      <a class="nav-item nav-link " href="/about/">About</a>

      

      <span id="theme-toggler" class="nav-item nav-link" role="button" onclick="toggleTheme()"></span>
    </div>
  </div>

</nav>
    <div class="col-lg-10 mx-auto mt-5 markdown-body">
  <h1><b>Do we need interfaces for unit testing?</b></h1>

<p class="post-metadata text-muted">
  17 May 2020 -  
  <b>13 mins read time</b>

  <br>Tags: 
    
    <a class="text-decoration-none no-underline" href="/blog/tags#c">
      <span class="tag badge badge-pill text-primary border border-primary">C#</span>
    </a>
    
    <a class="text-decoration-none no-underline" href="/blog/tags#testing">
      <span class="tag badge badge-pill text-primary border border-primary">Testing</span>
    </a>
    
    <a class="text-decoration-none no-underline" href="/blog/tags#architecture">
      <span class="tag badge badge-pill text-primary border border-primary">Architecture</span>
    </a>
    </p>

<p>Source: <a href="https://engineering.videoblocks.com/these-four-clean-code-tips-will-dramatically-improve-your-engineering-teams-productivity-b5bd121dd150">Jonathan Fulton</a></p>

<p>No we don’t need. It just doesn’t work like that and thinking this way can affect your project. So let’s imagine that you have a service that has some business logic and roles but in order to work, it must communicate with remote services and it also needs to use multiple databases. So, what will happen in the tests? The tests will require a long configuration of mocks and stubs. But why bother if there is a better way to do it. Firstly, what is most important for a good testing experience is the single responsibility principle, separation of concern, next is concentrating on writing the methods which have no side effects. Of course, also of importance is understanding basic patterns, which doesn’t mean “I know how to implement it”, it really means “I know which problem solves this pattern and why I use it”.</p>

<h2 id="what-about-solid">What about SOLID</h2>
<p>Now, I guess, somebody will say, “We need to inject each service through an interface because it must have a valid SOLID. “No, it’s not true. The dependency inversion is about the management of the dependency direction. Robert C. Martin wrote in his book about the “naive implementation of DIP”, meaning that the heuristic approach of “each object needs an interface and DIP” isn’t a good idea because we can always find any objects that are non-volatile and concrete. He also wrote about SDP; the Stable Dependencies Principle, wherein he demonstrated how to use DIP to manage the dependency direction, and which direction is correct.</p>

<h2 id="dip-and-architecture">DIP and Architecture</h2>
<p>We can find in other books patterns which are using dependency inversion in this way, for example, Decoupled Contract in SOA,</p>

<figure class="figure w-100">
  <img src="https://jaroslawszczerbaty.pl/assets/Img/contract.png?raw=true" class="figure-img img-fluid rounded" alt="Contract Layer from SOA" /><figcaption class="figure-caption text-center">Contract Layer from SOA</figcaption></figure>

<p>4 layers from Domain Driven Design, where we use a Repository interface in the domain layer to invert dependency of the infrastructure layer,</p>

<figure class="figure w-100">
  <img src="https://jaroslawszczerbaty.pl/assets/Img/DDD-DIP.jpg?raw=true" class="figure-img img-fluid rounded" alt="4 layers from DDD" /><figcaption class="figure-caption text-center">4 layers from DDD</figcaption></figure>

<p>Abstract Core, Hexagonal Architecture and so on.</p>

<h3 id="what-i-mean">What I mean?</h3>
<p>So why do I say all this? Because, using DIP for each “service”, “factories”, “parsers”, and so on can be redundant, and this can interferes with building a good architecture. Modern languages like C# also support other paradigms like functional programming. So, we can just use Func&lt;T,TResult&gt; or Action<T> delegates to inject what we need without any interfaces, and, in many cases, it will be much better because when we use a delegate to inject, for example, any source of data like SQL database, we don’t need to use any isolation framework like Moq to create mock or stub, and an even better way is to strongly separate methods with side effects and methods without side effects whenever possible. Thanks to this, the tests are more readable and much easier to write.</T></p>

<p>Let me show it
This is an example controller of ASP App. Of course, there is a lot of problems, like breaking MVC encapsulation, a legacy like TryUpdateModel, FormCollection, Repositories which are not doing what should do and so on. Let’s just take some ugly code to work on it.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">PassengerController</span> <span class="p">:</span> <span class="n">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">InformationAboutPassengers</span><span class="p">(</span><span class="n">FormCollection</span> <span class="n">formCollection</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">viewModel</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">PassengerInformationViewModel</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="nf">TryUpdateModel</span><span class="p">(</span><span class="n">viewModel</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">confirmationEmail</span> <span class="p">=</span> <span class="n">emailService</span><span class="p">.</span><span class="nf">GetConfirmationEmail</span><span class="p">(</span><span class="n">viewModel</span><span class="p">.</span><span class="n">Email</span><span class="p">);</span>

            <span class="kt">var</span> <span class="n">passengersPositions</span> <span class="p">=</span> 
                <span class="k">new</span> <span class="nf">Regex</span><span class="p">(</span><span class="s">@"&gt;\p{Lu}{1}\p{Ll}+(\s{1}\p{Lu}{3,}(-\p{Lu}{3,})?)+&lt;"</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Matches</span><span class="p">(</span><span class="n">confirmationEmail</span><span class="p">)</span>
                <span class="p">.</span><span class="n">Cast</span><span class="p">&lt;</span><span class="n">Match</span><span class="p">&gt;()</span>
                <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span> <span class="n">m</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(!</span><span class="n">passengersPositions</span><span class="p">.</span><span class="nf">Any</span><span class="p">())</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ApplicationException</span><span class="p">(</span><span class="s">"No passengers positions."</span><span class="p">);</span>

            <span class="kt">var</span> <span class="n">passengers</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Collection</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>

            <span class="kt">var</span> <span class="n">vipPassengers</span> <span class="p">=</span> <span class="n">passengerRepository</span>
                <span class="p">.</span><span class="nf">QueryVipPassengersByPosition</span><span class="p">(</span><span class="n">passengersPositions</span><span class="p">);</span>

            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">passengersPosition</span> <span class="k">in</span> <span class="n">passengersPositions</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">matchPassengerValueByRegex</span> <span class="p">=</span> 
                    <span class="k">new</span> <span class="nf">Regex</span><span class="p">(</span><span class="s">@"(\s{1}\p{Lu}{3,}(-\p{Lu}{3,})?)+"</span><span class="p">)</span>
                    <span class="p">.</span><span class="nf">Match</span><span class="p">(</span><span class="n">passengersPosition</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(!</span><span class="n">matchPassengerValueByRegex</span><span class="p">.</span><span class="n">Success</span><span class="p">)</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">"Error"</span><span class="p">);</span>

                <span class="kt">var</span> <span class="n">passenger</span> <span class="p">=</span> <span class="n">matchPassengerValueByRegex</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="nf">Substring</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>

                <span class="n">passengers</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">passenger</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="n">viewModel</span><span class="p">.</span><span class="n">Passengers</span> <span class="p">=</span> <span class="n">passengers</span>
                <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span> <span class="p">!=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Distinct</span><span class="p">();</span>

            <span class="n">viewModel</span><span class="p">.</span><span class="n">VipPassengers</span> <span class="p">=</span> <span class="n">vipPassengers</span><span class="p">.</span><span class="nf">Distinct</span><span class="p">();</span>

            <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">viewModel</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nf">RedirectToAction</span><span class="p">(</span><span class="s">"Index"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now look on the test, long isn’t?</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">Test</span><span class="p">]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">Test</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">autoMoq</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">AutoMoqer</span><span class="p">();</span>

    <span class="n">autoMoq</span><span class="p">.</span><span class="n">GetMock</span><span class="p">&lt;</span><span class="n">IEmailService</span><span class="p">&gt;()</span>
        <span class="p">.</span><span class="nf">Setup</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nf">GetConfirmationEmail</span><span class="p">(</span><span class="n">It</span><span class="p">.</span><span class="n">IsAny</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;()))</span>
        <span class="p">.</span><span class="nf">Returns</span><span class="p">(</span><span class="s">"Email content"</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">callback</span> <span class="p">=</span> <span class="n">Enumerable</span><span class="p">.</span><span class="n">Empty</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
    <span class="n">autoMoq</span><span class="p">.</span><span class="n">GetMock</span><span class="p">&lt;</span><span class="n">IPassengerRepository</span><span class="p">&gt;()</span>
	<span class="p">.</span><span class="nf">Setup</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nf">QueryVipPassengersByPosition</span><span class="p">(</span><span class="n">It</span><span class="p">.</span><span class="n">IsAny</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;&gt;()))</span>
        <span class="p">.</span><span class="n">Callback</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;&gt;(</span><span class="n">vipPassengers</span> <span class="p">=&gt;</span> <span class="n">callback</span> <span class="p">=</span> <span class="n">vipPassengers</span><span class="p">);</span> 

    <span class="kt">var</span> <span class="n">form</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FormCollection</span><span class="p">();</span>
    <span class="n">form</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"Email"</span><span class="p">,</span> <span class="s">"AnyEmail"</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="n">autoMoq</span><span class="p">.</span><span class="n">Create</span><span class="p">&lt;</span><span class="n">PassengerController</span><span class="p">&gt;()</span>
        <span class="p">.</span><span class="nf">InformationAboutPassengers</span><span class="p">(</span><span class="n">form</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="p">(</span><span class="n">ViewResult</span><span class="p">)</span><span class="n">response</span><span class="p">;</span>
    <span class="kt">var</span> <span class="n">viewModel</span> <span class="p">=</span> <span class="p">(</span><span class="n">PassengerInformationViewModel</span><span class="p">)</span><span class="n">result</span><span class="p">.</span><span class="n">ViewData</span><span class="p">.</span><span class="n">Model</span><span class="p">;</span>

    <span class="kt">var</span> <span class="n">expectedCallBack</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;()</span>
    <span class="p">{</span>
        <span class="s">"any string"</span><span class="p">,</span>
        <span class="s">"any string"</span>
    <span class="p">};</span>

    <span class="kt">var</span> <span class="n">expectedPassengers</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span>
    <span class="p">{</span>
        <span class="s">"any string"</span><span class="p">,</span>
        <span class="s">"any string"</span>
    <span class="p">};</span>

    <span class="n">CollectionAssert</span><span class="p">.</span><span class="nf">AreEqual</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">expectedCallBack</span><span class="p">);</span>
    <span class="n">CollectionAssert</span><span class="p">.</span><span class="nf">AreEqual</span><span class="p">(</span><span class="n">viewModel</span><span class="p">.</span><span class="n">Passengers</span><span class="p">,</span> <span class="n">expectedPassengers</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
<h3 id="first-refactoring">First refactoring</h3>
<p>All right, let’s get rid of all UI framework dependencies. Let’s cut off the Moq from tests.</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
<span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">InformationAboutPassengers</span><span class="p">(</span><span class="n">FormCollection</span> <span class="n">formCollection</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">viewModel</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">PassengerInformationViewModel</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="nf">TryUpdateModel</span><span class="p">(</span><span class="n">viewModel</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">newViewModel</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">passengersViewModelProvaider</span>
            <span class="p">.</span><span class="nf">PassengerInformationViewModel</span><span class="p">(</span><span class="n">viewModel</span><span class="p">.</span><span class="n">Email</span><span class="p">);</span>

        <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">newViewModel</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nf">RedirectToAction</span><span class="p">(</span><span class="s">"Index"</span><span class="p">);</span>
<span class="p">}</span>
<span class="p">...</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">PassengerService</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">Result</span> <span class="nf">GetPassengerInformation</span><span class="p">(</span><span class="kt">string</span> <span class="n">confirmationEmail</span><span class="p">,</span>
        <span class="n">Func</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;,</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;&gt;</span> <span class="n">vipPassengersStrategy</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">passengersPositions</span> <span class="p">=</span> 
            <span class="k">new</span> <span class="nf">Regex</span><span class="p">(</span><span class="s">@"&gt;\p{Lu}{1}\p{Ll}+(\s{1}\p{Lu}{3,}(-\p{Lu}{3,})?)+&lt;"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">Matches</span><span class="p">(</span><span class="n">confirmationEmail</span><span class="p">)</span>
            <span class="p">.</span><span class="n">Cast</span><span class="p">&lt;</span><span class="n">Match</span><span class="p">&gt;()</span>
            <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span> <span class="n">m</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(!</span><span class="n">passengersPositions</span><span class="p">.</span><span class="nf">Any</span><span class="p">())</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ApplicationException</span><span class="p">(</span><span class="s">"No passengers positions."</span><span class="p">);</span>

        <span class="kt">var</span> <span class="n">passengers</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Collection</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
        <span class="kt">var</span> <span class="n">vipPassengers</span> <span class="p">=</span> <span class="nf">vipPassengersStrategy</span><span class="p">(</span><span class="n">passengersPositions</span><span class="p">);</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">passengersPosition</span> <span class="k">in</span> <span class="n">passengersPositions</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">matchPassengerValueByRegex</span> <span class="p">=</span> 
		<span class="k">new</span> <span class="nf">Regex</span><span class="p">(</span><span class="s">@"(\s{1}\p{Lu}{3,}(-\p{Lu}{3,})?)+"</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Match</span><span class="p">(</span><span class="n">passengersPosition</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(!</span><span class="n">matchPassengerValueByRegex</span><span class="p">.</span><span class="n">Success</span><span class="p">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">"Error"</span><span class="p">);</span>

            <span class="kt">var</span> <span class="n">passenger</span> <span class="p">=</span> <span class="n">matchPassengerValueByRegex</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="nf">Substring</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>

            <span class="n">passengers</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">passenger</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Result</span><span class="p">();</span>

        <span class="n">result</span><span class="p">.</span><span class="n">Passengers</span> <span class="p">=</span> <span class="n">passengers</span>
            <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">p</span> <span class="p">=&gt;</span> <span class="n">p</span> <span class="p">!=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">Distinct</span><span class="p">();</span>

        <span class="n">result</span><span class="p">.</span><span class="n">VipPassengers</span> <span class="p">=</span> <span class="n">vipPassengers</span><span class="p">.</span><span class="nf">Distinct</span><span class="p">();</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">PassengersViewModelProvaider</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IEmailService</span> <span class="n">emailService</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IPassengerRepository</span> <span class="n">passengerRepository</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">PassengersViewModelProvaider</span><span class="p">(</span><span class="n">IEmailService</span> <span class="n">emailService</span><span class="p">,</span>
        <span class="n">IPassengerRepository</span> <span class="n">passengerRepository</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">emailService</span> <span class="p">=</span> <span class="n">emailService</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">passengerRepository</span> <span class="p">=</span> <span class="n">passengerRepository</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">PassengerInformationViewModel</span> <span class="nf">PassengerInformationViewModel</span><span class="p">(</span><span class="kt">string</span> <span class="n">email</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">viewModel</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">PassengerInformationViewModel</span><span class="p">();</span>
        <span class="kt">var</span> <span class="n">confirmationEmail</span> <span class="p">=</span> <span class="n">emailService</span><span class="p">.</span><span class="nf">GetConfirmationEmail</span><span class="p">(</span><span class="n">viewModel</span><span class="p">.</span><span class="n">Email</span><span class="p">);</span>

        <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">PassengerService</span><span class="p">().</span><span class="nf">GetPassengerInformation</span><span class="p">(</span><span class="n">confirmationEmail</span><span class="p">,</span>
            <span class="n">Positions</span> <span class="p">=&gt;</span> <span class="n">passengerRepository</span><span class="p">.</span><span class="nf">QueryVipPassengersByPosition</span><span class="p">(</span><span class="n">Positions</span><span class="p">));</span>

        <span class="n">viewModel</span><span class="p">.</span><span class="n">Email</span> <span class="p">=</span> <span class="n">email</span><span class="p">;</span>
        <span class="n">viewModel</span><span class="p">.</span><span class="n">Passengers</span> <span class="p">=</span> <span class="n">result</span><span class="p">.</span><span class="n">Passengers</span><span class="p">;</span>
        <span class="n">viewModel</span><span class="p">.</span><span class="n">VipPassengers</span> <span class="p">=</span> <span class="n">result</span><span class="p">.</span><span class="n">VipPassengers</span><span class="p">;</span>

        <span class="k">return</span> <span class="n">viewModel</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now let’s look at what happened in the test, better isn’t?</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">Test</span><span class="p">]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">Test</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">PassengerService</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">PassengerService</span><span class="p">();</span>

    <span class="kt">var</span> <span class="n">callback</span> <span class="p">=</span> <span class="n">Enumerable</span><span class="p">.</span><span class="n">Empty</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
    <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">PassengerService</span><span class="p">.</span><span class="nf">GetPassengerInformation</span><span class="p">(</span><span class="s">"email confirmation"</span><span class="p">,</span>
            <span class="n">vipPassengersStrategy</span><span class="p">:</span> <span class="n">x</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="n">callback</span> <span class="p">=</span> <span class="n">x</span><span class="p">;</span> <span class="k">return</span> <span class="k">null</span><span class="p">;</span> <span class="p">});</span>

    <span class="kt">var</span> <span class="n">expectedCallBack</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;()</span>
    <span class="p">{</span>
        <span class="s">"any string"</span><span class="p">,</span>
        <span class="s">"any string"</span>
    <span class="p">};</span>

    <span class="kt">var</span> <span class="n">expectedPassengers</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span>
    <span class="p">{</span>
        <span class="s">"any string"</span><span class="p">,</span>
        <span class="s">"any string"</span>
    <span class="p">};</span>

    <span class="n">CollectionAssert</span><span class="p">.</span><span class="nf">AreEqual</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">expectedCallBack</span><span class="p">);</span>
    <span class="n">CollectionAssert</span><span class="p">.</span><span class="nf">AreEqual</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">Passengers</span><span class="p">,</span> <span class="n">expectedPassengers</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="second-refactoring">Second refactoring</h3>
<p>Let’s correctly implemented the MVC pattern, remove “repository”, provide SRP and separate methods with side effects.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">PassengerController</span> <span class="p">:</span> <span class="n">Controller</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">PassengersViewModelProvaider</span> <span class="n">passengersViewModelProvaider</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">PassengerController</span><span class="p">(</span><span class="n">PassengersViewModelProvaider</span> <span class="n">passengersViewModelProvaider</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">passengersViewModelProvaider</span> <span class="p">=</span> <span class="n">passengersViewModelProvaider</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">PassengerInformationViewModel</span><span class="p">(</span><span class="kt">string</span> <span class="n">email</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">newViewModel</span> <span class="p">=</span> <span class="n">passengersViewModelProvaider</span>
        <span class="p">.</span><span class="nf">GetPassengerInformationViewModel</span><span class="p">(</span><span class="n">email</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">newViewModel</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="k">return</span> <span class="nf">View</span><span class="p">(</span><span class="n">newViewModel</span><span class="p">);</span>

        <span class="k">return</span> <span class="nf">RedirectToAction</span><span class="p">(</span><span class="s">"Index"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">PassengersViewModelProvaider</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IEmailService</span> <span class="n">emailService</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IPassengerQueryService</span> <span class="n">passengerQueryService</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">PassengersViewModelProvaider</span><span class="p">(</span><span class="n">IEmailService</span> <span class="n">emailService</span><span class="p">,</span>
        <span class="n">IPassengerQueryService</span> <span class="n">passengerQueryService</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">emailService</span> <span class="p">=</span> <span class="n">emailService</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">passengerQueryService</span> <span class="p">=</span> <span class="n">passengerQueryService</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">PassengerInformationViewModel</span> <span class="nf">GetPassengerInformationViewModel</span><span class="p">(</span><span class="kt">string</span> <span class="n">email</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">confirmationEmail</span> <span class="p">=</span> <span class="n">emailService</span><span class="p">.</span><span class="nf">GetConfirmationEmail</span><span class="p">(</span><span class="n">email</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">Positions</span> <span class="p">=</span> <span class="n">ConfirmationEmailRewriter</span>
        <span class="p">.</span><span class="nf">RewritePassengersPositions</span><span class="p">(</span><span class="n">confirmationEmail</span><span class="p">);</span>

        <span class="kt">var</span> <span class="n">vipPassengers</span> <span class="p">=</span> <span class="n">passengerQueryService</span><span class="p">.</span><span class="nf">GetPassengers</span><span class="p">(</span><span class="n">Positions</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">passengers</span> <span class="p">=</span> <span class="n">PassengersRewriter</span><span class="p">.</span><span class="nf">RewritePassengers</span><span class="p">(</span><span class="n">Positions</span><span class="p">);</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nf">PassengerInformationViewModel</span><span class="p">(</span><span class="n">passengers</span><span class="p">,</span> <span class="n">vipPassengers</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">internal</span> <span class="k">class</span> <span class="nc">ConfirmationEmailRewriter</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">RewritePassengersPositions</span><span class="p">(</span><span class="kt">string</span> <span class="n">confirmationEmail</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Regex</span><span class="p">(</span><span class="s">@"&gt;\p{Lu}{1}\p{Ll}+(\s{1}\p{Lu}{3,}(-\p{Lu}{3,})?)+&lt;"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">Matches</span><span class="p">(</span><span class="n">confirmationEmail</span><span class="p">)</span>
            <span class="p">.</span><span class="n">Cast</span><span class="p">&lt;</span><span class="n">Match</span><span class="p">&gt;()</span>
            <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Success</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span> <span class="n">m</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">internal</span> <span class="k">class</span> <span class="nc">PassengersRewriter</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="nf">RewritePassengers</span><span class="p">(</span>
        <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">passengersPositions</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">regex</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Regex</span><span class="p">(</span><span class="s">@"(\s{1}\p{Lu}{3,}(-\p{Lu}{3,})?)+"</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">passengersPositions</span><span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">Position</span> <span class="p">=&gt;</span> <span class="n">regex</span><span class="p">.</span><span class="nf">Match</span><span class="p">(</span><span class="n">Position</span><span class="p">))</span>
            <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">mached</span> <span class="p">=&gt;</span> <span class="n">mached</span><span class="p">.</span><span class="n">Success</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">Position</span> <span class="p">=&gt;</span> <span class="n">Position</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="m">1</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">Position</span> <span class="p">=&gt;</span> <span class="n">Position</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="nf">Substring</span><span class="p">(</span><span class="m">1</span><span class="p">))</span>
            <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">Position</span> <span class="p">=&gt;</span> <span class="n">Position</span> <span class="p">!=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">Distinct</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Tests looks good, isn’t?</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">Test</span><span class="p">]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">Test</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">passengerPositions</span> <span class="p">=</span> <span class="n">ConfirmationEmailRewriter</span>
        <span class="p">.</span><span class="nf">RewritePassengersPositions</span><span class="p">(</span><span class="s">"confirmation"</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">expectedPassengerPositions</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;()</span>
    <span class="p">{</span>
        <span class="s">"any string"</span><span class="p">,</span>
        <span class="s">"any string"</span>
    <span class="p">};</span>

    <span class="n">CollectionAssert</span><span class="p">.</span><span class="nf">AreEqual</span><span class="p">(</span><span class="n">expectedPassengerPositions</span><span class="p">,</span> <span class="n">passengerPositions</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">[</span><span class="n">Test</span><span class="p">]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">Test2</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">anyPositions</span> <span class="p">=</span> <span class="n">Enumerable</span><span class="p">.</span><span class="n">Empty</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
    <span class="kt">var</span> <span class="n">passengers</span> <span class="p">=</span> <span class="n">PassengersRewriter</span><span class="p">.</span><span class="nf">RewritePassengers</span><span class="p">(</span><span class="n">anyPositions</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">expectedPassengers</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;()</span>
    <span class="p">{</span>
        <span class="s">"any string"</span><span class="p">,</span>
        <span class="s">"any string"</span>
    <span class="p">};</span>

    <span class="n">CollectionAssert</span><span class="p">.</span><span class="nf">AreEqual</span><span class="p">(</span><span class="n">expectedPassengers</span><span class="p">,</span> <span class="n">passengers</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The DIP is still there, the facade PassengersViewModelProvaider has declared in interfaces what needs, but in the controller, I don’t use the DIP because it has no sense. The facade just manages other transaction scripts to solve any business problem. If you need a unit test you can just test the PassengersRewriter, but if you need an integration test you can make a test on the facade.</p>

<h2 id="conclusion">Conclusion</h2>
<p>The dependency inversion principle isn’t about testing, it’s about the management of dependency direction. You don’t need interfaces for testing but it can be helpful. SRP, SOC and Separate methods without side effects are most important for a good testing experience. Mixing dependencies of UI framework with business logic is never a good idea.</p>



</div>
  </main>
  <footer class="mt-auto py-3 text-center">

  <small class="text-muted mb-2">
    <i class="fas fa-code"></i> with <i class="fas fa-heart"></i>
    by <strong>Jarosław Szczerbaty</strong>
  </small>

  <div class="container-fluid justify-content-center"><a class="social mx-1"  href="mailto:dto.jarek@gmail.com"
       style="color: #6c757d"
       onMouseOver="this.style.color='#db4437'"
       onMouseOut="this.style.color='#6c757d'">
      <i class="fas fa-envelope fa-1x"></i>
    </a><a class="social mx-1"  href="https://www.github.com/Ja-rek"
       style="color: #6c757d"
       onMouseOver="this.style.color='#333333'"
       onMouseOut="this.style.color='#6c757d'">
      <i class="fab fa-github fa-1x"></i>
    </a><a class="social mx-1"  href="https://www.linkedin.com/in/your_username"
       style="color: #6c757d"
       onMouseOver="this.style.color='#007bb5'"
       onMouseOut="this.style.color='#6c757d'">
      <i class="fab fa-linkedin-in fa-1x"></i>
    </a>

</div><small id="attribution">
    theme <a href="https://github.com/YoussefRaafatNasry/portfolYOU">portfolYOU</a>
  </small>

</footer>

  
  <!-- GitHub Buttons -->
<script async defer src="https://buttons.github.io/buttons.js"></script>

<!-- jQuery CDN -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<!-- Popper.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"></script>

<!-- Bootstrap JS CDN -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

<!-- wow.js CDN & Activation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/wow/1.1.2/wow.js"></script>
<script> new WOW().init(); </script>

<!-- Initialize all tooltips -->
<script>
$(function () {
    $('[data-toggle="tooltip"]').tooltip()
})
</script>
</body>

</html>